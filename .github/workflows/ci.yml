name: CI

on:
  push:
    branches: [main, develop]
  pull_request:

env:
  LLVM_VERSION: "18"
  CMAKE_BUILD_TYPE: Release

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install linting tools
        run: |
          pip install ruff black mypy

      - name: Run Ruff
        run: ruff check .

      - name: Run Black
        run: black --check .

      - name: Run MyPy
        run: mypy compiler/frontend/pycircuit || true

  build:
    name: Build (ubuntu-latest)
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build clang
          sudo apt-get install -y llvm-${LLVM_VERSION}-dev mlir-${LLVM_VERSION}-tools libmlir-${LLVM_VERSION}-dev || \
          sudo apt-get install -y llvm-dev mlir-tools libmlir-dev

      - name: Configure CMake
        run: |
          LLVM_CONFIG="$(command -v llvm-config || command -v llvm-config-${LLVM_VERSION} || echo llvm-config)"
          if [ -z "$(command -v $LLVM_CONFIG 2>/dev/null)" ]; then
            LLVM_CONFIG=$(find /usr -name 'llvm-config*' 2>/dev/null | head -1)
          fi
          LLVM_DIR="$(${LLVM_CONFIG} --cmakedir)"
          MLIR_DIR="$(dirname "$LLVM_DIR")/mlir"

          cmake -G Ninja -S . -B build \
            -DCMAKE_BUILD_TYPE=$CMAKE_BUILD_TYPE \
            -DLLVM_DIR="$LLVM_DIR" \
            -DMLIR_DIR="$MLIR_DIR" \
            -DPYC_BUILD_CPP_EXAMPLES=OFF

      - name: Build
        run: ninja -C build pycc pyc-opt

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pycc-build
          path: build/bin/
          retention-days: 1

  test-examples:
    name: Test Examples
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: pycc-build
          path: build/bin/

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run examples
        run: |
          chmod +x build/bin/pycc
          bash flows/scripts/run_examples.sh

      - name: Run simulations
        run: |
          sudo apt-get install -y verilator iverilog
          bash flows/scripts/run_sims.sh || true

  test-cpu:
    name: Test Linx CPU
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: pycc-build
          path: build/bin/

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y verilator

      - name: Run Linx CPU tests
        run: |
          chmod +x build/bin/pycc
          bash flows/tools/run_fastfwd_pyc_cpp.sh || true

  macos-build:
    name: Build (macOS)
    runs-on: macos-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Homebrew packages
        run: |
          brew install ninja cmake llvm python@3

      - name: Set up environment
        run: |
          echo "$(brew --prefix llvm)/bin" >> $GITHUB_PATH

      - name: Configure CMake
        run: |
          LLVM_CONFIG="$(command -v llvm-config)"
          LLVM_DIR="$(${LLVM_CONFIG} --cmakedir)"
          MLIR_DIR="$(dirname "$LLVM_DIR")/mlir"

          cmake -G Ninja -S . -B build \
            -DCMAKE_BUILD_TYPE=$CMAKE_BUILD_TYPE \
            -DLLVM_DIR="$LLVM_DIR" \
            -DMLIR_DIR="$MLIR_DIR" \
            -DPYC_BUILD_CPP_EXAMPLES=OFF

      - name: Build
        run: ninja -C build pycc pyc-opt
